<?php

require_once 'config.php';

class Vulnerability {

protected $vul;

    function __construct(){

    }

    function getVul(){
        $db = new Database();
        $db->query('SELECT * FROM yoboukale.reports');
        $db->execute();
        $row = $db->resultset();

        foreach($row as $item){
            $ip = $item['ip'];
            $file = $item['report_file_name'];
            $xml=simplexml_load_string($row['0']['report']) or die("Error: Cannot create object");
            $value = $xml;


            echo <<<__END
                <div class="card">
                    <div class="blurring dimmable image">
                        <div class="ui dimmer">
                            <div class="content">
                                <div class="center">
                                    <div class="ui inverted button">Add Friend</div>
                                </div>
                            </div>
                        </div>
                        <img src="/images/avatar/large/elliot.jpg">
                    </div>
                    <div class="content">
                        <a href='viewResult.php?result=$file' class="header">$ip</a>
                        <div class="meta">
                            <span class="date">Create in Sep 2014</span>
                        </div>
                    </div>
                    <div class="extra content">
                        <a>
                            <i class="users icon"></i>
                            1 Vulnerabilités
                        </a>
                    </div>
                </div>
__END;

        }
    }

    function showVul($file){
        $db = new Database();
        $db->query('SELECT * FROM reports WHERE report_file_name = :file');
        $db->bind(':file', $file);
        $db->execute();
        $row = $db->resultset();

        $xml=simplexml_load_string($row['0']['report']) or die("Error: Cannot create object");
        $value = $xml;

        $dom = new DOMDocument;
        $dom->loadXML($row['0']['report']);
        $books = $dom->getElementsByTagName('name');
        foreach ($books as $book) {
            $vulF = $book->nodeValue;
            break;
        }

        $cves = $dom->getElementsByTagName('cve');
        foreach ($cves as $cve) {
            $cveF = $cve->nodeValue;
            echo "</br>";
        }

        $ports = $dom->getElementsByTagName('port');
        foreach ($ports as $port) {
            $portF = $port->nodeValue;
        }

        $threats = $dom->getElementsByTagName('threat');
        foreach ($threats as $threat) {
            $threatF = $threat->nodeValue;
        }

        echo <<<_END
        <tr>
            <td>$vulF</td>
            <td><a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=$cveF">$cveF</a></td>
            <td>$portF</td>
            <td>$threatF</td>
        </tr>


_END;

        $config = array(
            'clientId' => 'tj0D05IC7lW9FdXySGX8ILGlqBUBrKSo',
            'clientSecret' => 'ZZ67s0pef9mVKqJG'
        );

        $osms = new \Osms\Osms($config);

        // retrieve an access token
        $response = $osms->getTokenFromConsumerKey();

        if (!empty($response['access_token'])) {
            $senderAddress = 'tel:+22500000000';
            $receiverAddress = 'tel:+22579511751';
            $message = $vulF.' trouvé sur le port '.$portF;
            $senderName = 'Yobouekale';

            $osms->sendSMS($senderAddress, $receiverAddress, $message, $senderName);
        } else {
            // error
        }


        if (!empty($response['access_token'])) {
            $senderAddress = 'tel:+22500000000';
            $receiverAddress = 'tel:+22557635976';
            $message = $vulF.' trouvé sur le port '.$portF;
            $senderName = 'Yobouekale';

            $osms->sendSMS($senderAddress, $receiverAddress, $message, $senderName);
        } else {
            // error
        }


        if (!empty($response['access_token'])) {
            $senderAddress = 'tel:+22500000000';
            $receiverAddress = 'tel:+22577306749';
            $message = $vulF.' trouvé sur le port '.$portF;
            $senderName = 'Yobouekale';

            $osms->sendSMS($senderAddress, $receiverAddress, $message, $senderName);
        } else {
            // error
        }

        if (!empty($response['access_token'])) {
            $senderAddress = 'tel:+22500000000';
            $receiverAddress = 'tel:+22577844192';
            $message = $vulF.' trouvé sur le port '.$portF;
            $senderName = 'Yobouekale';

            $osms->sendSMS($senderAddress, $receiverAddress, $message, $senderName);
        } else {
            // error
        }

        if (!empty($response['access_token'])) {
            $senderAddress = 'tel:+22500000000';
            $receiverAddress = 'tel:+22505007076';
            $message = $vulF.' trouvé sur le port '.$portF;
            $senderName = 'Yobouekale';

            $osms->sendSMS($senderAddress, $receiverAddress, $message, $senderName);
        } else {
            // error
        }



    }
}
?>